<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Locative</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #F7F3EE;
    --warm-white: #FDFAF7;
    --charcoal: #2C2825;
    --brown: #7C5C3E;
    --terracotta: #C4704A;
    --sage: #7A8C6E;
    --gold: #C9A96E;
    --light-brown: #E8DDD0;
    --mid-brown: #D4C4B0;
    --text-muted: #8A7A6A;
    --gmail-red: #EA4335;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    color: var(--charcoal);
    min-height: 100vh;
  }

  .app { display: flex; min-height: 100vh; }

  /* SIDEBAR */
  .sidebar {
    width: 260px;
    background: var(--charcoal);
    color: var(--cream);
    padding: 32px 0;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow-y: auto;
  }

  .sidebar-logo { padding: 0 24px 28px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  .sidebar-logo h1 { font-family: 'DM Serif Display', serif; font-size: 1.4rem; line-height: 1.2; color: var(--gold); }
  .sidebar-logo p { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.1em; }

  .gmail-status {
    margin: 16px 24px;
    padding: 10px 14px;
    border-radius: 10px;
    font-size: 0.78rem;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid rgba(255,255,255,0.1);
  }
  .gmail-status.connected { background: rgba(122,140,110,0.2); border-color: var(--sage); color: #A8C49A; }
  .gmail-status.disconnected { background: rgba(234,67,53,0.15); border-color: rgba(234,67,53,0.3); color: #F08080; }
  .gmail-status .dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .gmail-status.connected .dot { background: var(--sage); box-shadow: 0 0 6px var(--sage); }
  .gmail-status.disconnected .dot { background: var(--gmail-red); }
  .gmail-status .gmail-email { font-size: 0.7rem; opacity: 0.8; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .sidebar-nav { padding: 12px 0; flex: 1; }
  .nav-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); padding: 0 24px; margin-bottom: 6px; margin-top: 16px; }
  .nav-item { display: flex; align-items: center; gap: 10px; padding: 10px 24px; cursor: pointer; transition: all 0.2s; font-size: 0.88rem; color: rgba(247,243,238,0.7); border-left: 3px solid transparent; }
  .nav-item:hover { background: rgba(255,255,255,0.05); color: var(--cream); }
  .nav-item.active { background: rgba(201,169,110,0.15); color: var(--gold); border-left-color: var(--gold); }
  .nav-item .icon { font-size: 1rem; width: 20px; text-align: center; }

  .badge { display: inline-flex; align-items: center; justify-content: center; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; font-size: 0.65rem; font-weight: 700; margin-left: auto; }
  .badge-red { background: var(--gmail-red); color: white; }
  .badge-brown { background: var(--terracotta); color: white; }

  .sidebar-footer { padding: 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; color: var(--text-muted); }

  /* MAIN */
  .main { flex: 1; overflow-y: auto; padding: 40px; }

  .page { display: none; }
  .page.active { display: block; animation: fadeIn 0.25s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }

  /* PAGE HEADER */
  .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 32px; }
  .page-title { font-family: 'DM Serif Display', serif; font-size: 2rem; color: var(--charcoal); }
  .page-title span { font-style: italic; color: var(--terracotta); }
  .page-subtitle { color: var(--text-muted); font-size: 0.88rem; margin-top: 4px; }

  /* STATS */
  .stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 36px; }
  .stat-card { background: var(--warm-white); border-radius: 12px; padding: 20px; border: 1px solid var(--light-brown); text-align: center; }
  .stat-card .stat-value { font-family: 'DM Serif Display', serif; font-size: 2rem; color: var(--terracotta); }
  .stat-card .stat-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.08em; }

  /* CARDS */
  .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
  .apt-card { background: var(--warm-white); border-radius: 16px; overflow: hidden; border: 1px solid var(--light-brown); cursor: pointer; transition: all 0.25s; }
  .apt-card:hover { transform: translateY(-3px); box-shadow: 0 12px 40px rgba(44,40,37,0.12); border-color: var(--gold); }
  .apt-card-img { height: 155px; background: var(--light-brown); position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
  .apt-card-img .no-photo { text-align: center; color: var(--text-muted); }
  .apt-card-img .no-photo span { font-size: 2.5rem; display: block; }
  .apt-card-img .no-photo p { font-size: 0.72rem; margin-top: 4px; }
  .apt-card-img img { width: 100%; height: 100%; object-fit: cover; }
  .apt-status-badge { position: absolute; top: 10px; right: 10px; padding: 3px 9px; border-radius: 20px; font-size: 0.68rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; }
  .status-disponible { background: var(--sage); color: white; }
  .status-loue { background: var(--terracotta); color: white; }
  .status-en-cours { background: var(--gold); color: var(--charcoal); }
  .apt-card-body { padding: 18px 20px 12px; }
  .apt-card-title { font-family: 'DM Serif Display', serif; font-size: 1.1rem; margin-bottom: 5px; }
  .apt-card-meta { font-size: 0.78rem; color: var(--text-muted); display: flex; gap: 10px; flex-wrap: wrap; }
  .apt-card-footer { padding: 10px 20px; border-top: 1px solid var(--light-brown); display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
  .candidate-count { color: var(--brown); font-weight: 500; }
  .apt-price { font-family: 'DM Serif Display', serif; font-size: 1.05rem; color: var(--terracotta); }

  /* BUTTONS */
  .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s; text-decoration: none; }
  .btn-primary { background: var(--terracotta); color: white; }
  .btn-primary:hover { background: #B5613D; transform: translateY(-1px); }
  .btn-gmail { background: var(--gmail-red); color: white; }
  .btn-gmail:hover { background: #C62828; transform: translateY(-1px); }
  .btn-secondary { background: transparent; color: var(--brown); border: 1.5px solid var(--mid-brown); }
  .btn-secondary:hover { background: var(--light-brown); }
  .btn-ghost { background: transparent; color: var(--text-muted); }
  .btn-ghost:hover { color: var(--charcoal); background: var(--light-brown); }
  .btn-sm { padding: 6px 14px; font-size: 0.78rem; }
  .btn-icon { background: none; border: none; cursor: pointer; padding: 6px; border-radius: 6px; color: var(--text-muted); transition: all 0.2s; font-size: 1rem; }
  .btn-icon:hover { background: var(--light-brown); color: var(--charcoal); }

  /* TABS */
  .tabs { display: flex; gap: 4px; background: var(--light-brown); padding: 4px; border-radius: 10px; margin-bottom: 24px; }
  .tab { flex: 1; text-align: center; padding: 9px; border-radius: 7px; cursor: pointer; font-size: 0.82rem; color: var(--text-muted); transition: all 0.2s; border: none; background: none; font-family: 'DM Sans', sans-serif; }
  .tab.active { background: white; color: var(--charcoal); font-weight: 600; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; animation: fadeIn 0.2s ease; }

  /* MODAL */
  .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(44,40,37,0.6); z-index: 1000; backdrop-filter: blur(4px); align-items: center; justify-content: center; padding: 20px; }
  .modal-overlay.open { display: flex; animation: fadeIn 0.2s ease; }
  .modal { background: var(--warm-white); border-radius: 20px; max-width: 680px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 30px 80px rgba(44,40,37,0.25); }
  .modal-lg { max-width: 820px; }
  .modal-header { padding: 26px 32px 18px; border-bottom: 1px solid var(--light-brown); display: flex; justify-content: space-between; align-items: center; }
  .modal-title { font-family: 'DM Serif Display', serif; font-size: 1.35rem; }
  .modal-body { padding: 26px 32px; }
  .modal-footer { padding: 18px 32px; border-top: 1px solid var(--light-brown); display: flex; gap: 10px; justify-content: flex-end; }

  /* FORM */
  .form-group { margin-bottom: 18px; }
  .form-label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--charcoal); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em; }
  .form-input, .form-textarea, .form-select { width: 100%; padding: 10px 14px; border: 1.5px solid var(--mid-brown); border-radius: 8px; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; background: white; color: var(--charcoal); transition: border-color 0.2s; outline: none; }
  .form-input:focus, .form-textarea:focus, .form-select:focus { border-color: var(--terracotta); }
  .form-textarea { min-height: 100px; resize: vertical; }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

  /* TEMPLATE BOX */
  .template-box { background: white; border: 1.5px solid var(--light-brown); border-radius: 12px; padding: 20px; margin-bottom: 14px; }
  .template-box:hover { border-color: var(--gold); }
  .template-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 8px; }
  .template-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--brown); }
  .template-actions { display: flex; gap: 4px; flex-wrap: wrap; }
  .template-content { font-size: 0.87rem; color: var(--text-muted); line-height: 1.7; white-space: pre-wrap; font-style: italic; }

  /* CANDIDATE */
  .candidate-item { background: white; border: 1.5px solid var(--light-brown); border-radius: 12px; padding: 14px 18px; margin-bottom: 10px; transition: all 0.2s; }
  .candidate-item:hover { border-color: var(--mid-brown); box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
  .candidate-row { display: flex; align-items: center; gap: 14px; }
  .candidate-avatar { width: 42px; height: 42px; border-radius: 50%; background: var(--light-brown); display: flex; align-items: center; justify-content: center; font-family: 'DM Serif Display', serif; font-size: 1.1rem; color: var(--brown); flex-shrink: 0; }
  .candidate-info { flex: 1; min-width: 0; }
  .candidate-name { font-weight: 600; font-size: 0.9rem; margin-bottom: 2px; }
  .candidate-detail { font-size: 0.76rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .candidate-status { font-size: 0.7rem; padding: 3px 9px; border-radius: 20px; font-weight: 600; white-space: nowrap; flex-shrink: 0; }
  .cstatus-nouveau { background: #E8F4FD; color: #2980B9; }
  .cstatus-fiche-envoyee { background: #FEF9E7; color: #D68910; }
  .cstatus-visite { background: #E9F7EF; color: #27AE60; }
  .cstatus-refuse { background: #FDEDEC; color: #E74C3C; }
  .candidate-actions { display: flex; gap: 4px; flex-shrink: 0; }

  /* GMAIL PANEL */
  .gmail-connect-banner {
    background: white;
    border: 2px dashed var(--mid-brown);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    margin-bottom: 24px;
  }
  .gmail-connect-banner .big-icon { font-size: 3rem; display: block; margin-bottom: 12px; }
  .gmail-connect-banner h3 { font-family: 'DM Serif Display', serif; font-size: 1.3rem; margin-bottom: 8px; }
  .gmail-connect-banner p { color: var(--text-muted); font-size: 0.88rem; margin-bottom: 20px; max-width: 420px; margin-left: auto; margin-right: auto; }

  /* EMAIL LIST */
  .email-toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .email-search {
    flex: 1;
    min-width: 200px;
    padding: 9px 14px;
    border: 1.5px solid var(--mid-brown);
    border-radius: 8px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    outline: none;
    background: white;
  }
  .email-search:focus { border-color: var(--terracotta); }

  .email-item {
    background: white;
    border: 1.5px solid var(--light-brown);
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    gap: 14px;
    align-items: flex-start;
  }
  .email-item:hover { border-color: var(--gold); box-shadow: 0 2px 12px rgba(0,0,0,0.07); }
  .email-item.unread { border-left: 3px solid var(--terracotta); }
  .email-item.unread .email-subject { font-weight: 700; color: var(--charcoal); }
  .email-avatar { width: 38px; height: 38px; border-radius: 50%; background: var(--light-brown); display: flex; align-items: center; justify-content: center; font-family: 'DM Serif Display', serif; font-size: 1rem; color: var(--brown); flex-shrink: 0; }
  .email-content { flex: 1; min-width: 0; }
  .email-from { font-size: 0.82rem; font-weight: 600; margin-bottom: 2px; }
  .email-subject { font-size: 0.85rem; color: var(--charcoal); margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .email-preview { font-size: 0.78rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .email-meta { text-align: right; flex-shrink: 0; }
  .email-date { font-size: 0.72rem; color: var(--text-muted); white-space: nowrap; }
  .email-apt-tag { font-size: 0.65rem; padding: 2px 7px; border-radius: 10px; background: rgba(201,169,110,0.2); color: var(--brown); margin-top: 4px; display: inline-block; }

  /* EMAIL DETAIL */
  .email-detail { background: white; border: 1.5px solid var(--light-brown); border-radius: 14px; padding: 28px; }
  .email-detail-header { border-bottom: 1px solid var(--light-brown); padding-bottom: 18px; margin-bottom: 20px; }
  .email-detail-subject { font-family: 'DM Serif Display', serif; font-size: 1.3rem; margin-bottom: 10px; }
  .email-detail-meta { font-size: 0.82rem; color: var(--text-muted); display: flex; flex-wrap: wrap; gap: 12px; }
  .email-detail-body { font-size: 0.9rem; line-height: 1.8; white-space: pre-wrap; color: var(--charcoal); }
  .email-detail-actions { display: flex; gap: 8px; margin-top: 20px; padding-top: 18px; border-top: 1px solid var(--light-brown); flex-wrap: wrap; }

  /* COMPOSE */
  .compose-box { background: white; border: 1.5px solid var(--light-brown); border-radius: 14px; overflow: hidden; margin-bottom: 16px; }
  .compose-header { background: var(--charcoal); color: white; padding: 14px 20px; display: flex; justify-content: space-between; align-items: center; font-size: 0.88rem; font-weight: 600; }
  .compose-body { padding: 20px; }
  .compose-field { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--light-brown); padding: 8px 0; }
  .compose-field label { font-size: 0.78rem; color: var(--text-muted); width: 50px; flex-shrink: 0; }
  .compose-field input { flex: 1; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; }
  .compose-textarea { width: 100%; border: none; outline: none; font-family: 'DM Sans', sans-serif; font-size: 0.88rem; min-height: 180px; resize: vertical; padding: 14px 0; line-height: 1.7; }
  .compose-footer { padding: 12px 20px; border-top: 1px solid var(--light-brown); display: flex; gap: 8px; align-items: center; }

  /* SECTION */
  .section { margin-bottom: 32px; }
  .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
  .section-title { font-family: 'DM Serif Display', serif; font-size: 1.15rem; }

  /* APT DETAIL */
  .apt-detail-header { background: var(--charcoal); border-radius: 16px; padding: 28px 32px; color: white; margin-bottom: 24px; position: relative; overflow: hidden; }
  .apt-detail-header::before { content: ''; position: absolute; right: -40px; top: -40px; width: 180px; height: 180px; border-radius: 50%; background: rgba(201,169,110,0.1); }
  .apt-detail-name { font-family: 'DM Serif Display', serif; font-size: 1.7rem; color: var(--gold); margin-bottom: 6px; }
  .apt-detail-address { font-size: 0.88rem; color: rgba(255,255,255,0.6); margin-bottom: 18px; }
  .apt-detail-meta { display: flex; gap: 24px; flex-wrap: wrap; }
  .apt-detail-meta-item { font-size: 0.82rem; color: rgba(255,255,255,0.7); }
  .apt-detail-meta-item strong { color: white; display: block; font-size: 1.05rem; }

  .back-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); font-size: 0.85rem; display: flex; align-items: center; gap: 6px; margin-bottom: 18px; padding: 0; font-family: 'DM Sans', sans-serif; transition: color 0.2s; }
  .back-btn:hover { color: var(--charcoal); }

  /* PHOTO GRID */
  .photo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-bottom: 14px; }
  .photo-thumb { aspect-ratio: 1; border-radius: 8px; overflow: hidden; background: var(--light-brown); position: relative; }
  .photo-thumb img { width: 100%; height: 100%; object-fit: cover; }
  .photo-thumb:hover .photo-delete { opacity: 1; }
  .photo-delete { position: absolute; top: 5px; right: 5px; background: rgba(44,40,37,0.8); color: white; border: none; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 0.68rem; opacity: 0; transition: opacity 0.2s; }
  .photo-add { aspect-ratio: 1; border-radius: 8px; border: 2px dashed var(--mid-brown); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: all 0.2s; font-size: 0.72rem; }
  .photo-add:hover { border-color: var(--terracotta); color: var(--terracotta); background: rgba(196,112,74,0.05); }
  .photo-add .plus { font-size: 1.6rem; line-height: 1; }

  /* FICHE */
  .fiche-preview { background: white; border: 2px solid var(--light-brown); border-radius: 12px; padding: 28px; font-size: 0.88rem; line-height: 1.8; }
  .fiche-preview h3 { font-family: 'DM Serif Display', serif; font-size: 1.2rem; margin-bottom: 18px; padding-bottom: 10px; border-bottom: 2px solid var(--light-brown); }
  .fiche-field { display: flex; gap: 8px; margin-bottom: 8px; align-items: flex-end; }
  .fiche-field label { font-weight: 600; color: var(--brown); min-width: 160px; flex-shrink: 0; font-size: 0.8rem; }
  .fiche-field .fiche-line { flex: 1; border-bottom: 1px solid var(--mid-brown); min-height: 22px; }
  .fiche-section-title { font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; font-size: 0.7rem; color: var(--text-muted); margin: 18px 0 8px; padding-top: 12px; border-top: 1px solid var(--light-brown); }

  /* COPY BTN */
  .copy-btn { font-size: 0.72rem; padding: 5px 10px; background: var(--light-brown); border: 1px solid var(--mid-brown); border-radius: 6px; cursor: pointer; color: var(--brown); transition: all 0.2s; }
  .copy-btn:hover { background: var(--terracotta); color: white; border-color: var(--terracotta); }

  /* SETUP GUIDE */
  .setup-step { display: flex; gap: 16px; margin-bottom: 24px; }
  .step-number { width: 32px; height: 32px; border-radius: 50%; background: var(--terracotta); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.88rem; flex-shrink: 0; margin-top: 2px; }
  .step-content h4 { font-weight: 600; margin-bottom: 4px; font-size: 0.92rem; }
  .step-content p { font-size: 0.83rem; color: var(--text-muted); line-height: 1.6; }
  .step-content a { color: var(--terracotta); }
  .step-content code { background: var(--light-brown); padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; font-family: monospace; }
  .config-box { background: var(--light-brown); border-radius: 10px; padding: 16px; margin-top: 8px; }

  /* INFO BOX */
  .info-box { background: rgba(201,169,110,0.12); border: 1px solid rgba(201,169,110,0.4); border-radius: 10px; padding: 14px 18px; margin-bottom: 20px; font-size: 0.84rem; color: var(--brown); }
  .info-box strong { display: block; margin-bottom: 4px; }

  /* EMPTY */
  .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
  .empty-state .big-icon { font-size: 2.8rem; display: block; margin-bottom: 10px; }
  .empty-state p { margin-bottom: 16px; font-size: 0.88rem; }

  /* LOADING */
  .loading { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 30px; color: var(--text-muted); font-size: 0.88rem; }
  .spinner { width: 20px; height: 20px; border: 2px solid var(--light-brown); border-top-color: var(--terracotta); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* TOAST */
  .toast { position: fixed; bottom: 24px; right: 24px; background: var(--charcoal); color: white; padding: 12px 20px; border-radius: 10px; font-size: 0.85rem; z-index: 9999; transform: translateY(60px); opacity: 0; transition: all 0.3s ease; pointer-events: none; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.error { background: #C62828; }

  @media (max-width: 768px) {
    .sidebar { width: 100%; height: auto; position: relative; flex-direction: row; padding: 12px 0; overflow-x: auto; }
    .sidebar-logo, .sidebar-footer, .gmail-status, .nav-label { display: none; }
    .sidebar-nav { display: flex; flex-direction: row; padding: 0 12px; white-space: nowrap; flex: unset; }
    .stats-bar { grid-template-columns: repeat(2, 1fr); }
    .form-row { grid-template-columns: 1fr; }
    .main { padding: 20px 16px; }
    .tabs .tab { font-size: 0.74rem; padding: 8px 6px; }
  }
</style>
</head>
<body>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <h1>Mes<br>Locations</h1>
      <p>Gestion locative</p>
    </div>

    <!-- Gmail status indicator -->
    <div class="gmail-status disconnected" id="gmail-status-indicator" onclick="showPage('gmail')">
      <span class="dot"></span>
      <div>
        <div id="gmail-status-text">Gmail non connect√©</div>
        <span class="gmail-email" id="gmail-status-email">Cliquer pour configurer</span>
      </div>
    </div>

    <nav class="sidebar-nav">
      <div class="nav-label">Navigation</div>
      <div class="nav-item active" onclick="showPage('dashboard')">
        <span class="icon">üè†</span> Tableau de bord
      </div>
      <div class="nav-item" onclick="showPage('appartements')">
        <span class="icon">üîë</span> Appartements
        <span class="badge badge-brown" id="nav-count">4</span>
      </div>
      <div class="nav-label">Email</div>
      <div class="nav-item" onclick="showPage('gmail')">
        <span class="icon">üìß</span> Bo√Æte de r√©ception
        <span class="badge badge-red" id="unread-badge" style="display:none">0</span>
      </div>
      <div class="nav-item" onclick="showPage('compose')">
        <span class="icon">‚úçÔ∏è</span> Nouveau message
      </div>
      <div class="nav-label">Outils</div>
      <div class="nav-item" onclick="showPage('messages')">
        <span class="icon">üí¨</span> Messages types
      </div>
      <div class="nav-item" onclick="showPage('fiche')">
        <span class="icon">üìã</span> Fiche candidat
      </div>
      <div class="nav-item" onclick="showPage('settings')">
        <span class="icon">‚öôÔ∏è</span> Param√®tres
      </div>
    </nav>
    <div class="sidebar-footer">
      <span id="footer-apt-count">4</span> appartements ¬∑ <span id="footer-cand-count">0</span> candidats
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- DASHBOARD -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div>
          <h2 class="page-title">Tableau de <span>bord</span></h2>
          <p class="page-subtitle" id="dash-subtitle">Chargement‚Ä¶</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-add-apt')">+ Appartement</button>
      </div>
      <div class="stats-bar" id="stats-bar"></div>
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">üèò Vos appartements</h3>
        </div>
        <div class="cards-grid" id="dashboard-cards"></div>
      </div>
    </div>

    <!-- APPARTEMENTS -->
    <div class="page" id="page-appartements">
      <div class="page-header">
        <div>
          <h2 class="page-title">Mes <span>appartements</span></h2>
          <p class="page-subtitle">G√©rer vos biens et candidats</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-add-apt')">+ Ajouter</button>
      </div>
      <div class="cards-grid" id="apts-list-cards"></div>
    </div>

    <!-- APT DETAIL -->
    <div class="page" id="page-apt-detail">
      <button class="back-btn" onclick="showPage('appartements')">‚Üê Retour aux appartements</button>
      <div id="apt-detail-content"></div>
    </div>

    <!-- GMAIL / INBOX -->
    <div class="page" id="page-gmail">
      <div class="page-header">
        <div>
          <h2 class="page-title">Bo√Æte de <span>r√©ception</span></h2>
          <p class="page-subtitle" id="inbox-subtitle">Emails de votre adresse d√©di√©e</p>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary" id="btn-refresh-inbox" onclick="loadInbox()">‚Üª Actualiser</button>
          <button class="btn btn-gmail" onclick="showPage('compose')">‚úçÔ∏è Nouveau</button>
        </div>
      </div>
      <div id="gmail-page-content">
        <!-- filled by JS -->
      </div>
    </div>

    <!-- EMAIL DETAIL -->
    <div class="page" id="page-email-detail">
      <button class="back-btn" onclick="showPage('gmail')">‚Üê Retour √† la bo√Æte de r√©ception</button>
      <div id="email-detail-content"></div>
    </div>

    <!-- COMPOSE -->
    <div class="page" id="page-compose">
      <div class="page-header">
        <div>
          <h2 class="page-title">Nouveau <span>message</span></h2>
          <p class="page-subtitle">Composez un email depuis votre adresse d√©di√©e</p>
        </div>
      </div>
      <div id="compose-content"></div>
    </div>

    <!-- MESSAGES TYPES -->
    <div class="page" id="page-messages">
      <div class="page-header">
        <div>
          <h2 class="page-title">Messages <span>types</span></h2>
          <p class="page-subtitle">Mod√®les pr√™ts √† l'emploi</p>
        </div>
        <button class="btn btn-primary" onclick="openModal('modal-add-msg')">+ Ajouter</button>
      </div>
      <div id="messages-list"></div>
    </div>

    <!-- FICHE -->
    <div class="page" id="page-fiche">
      <div class="page-header">
        <div>
          <h2 class="page-title">Fiche <span>candidat</span></h2>
          <p class="page-subtitle">Formulaire pr√©-visite √† envoyer aux candidats</p>
        </div>
        <button class="btn btn-secondary" onclick="window.print()">üñ® Imprimer</button>
      </div>
      <div class="fiche-preview" id="fiche-content"></div>
    </div>

    <!-- SETTINGS -->
    <div class="page" id="page-settings">
      <div class="page-header">
        <div>
          <h2 class="page-title"><span>Param√®tres</span> Gmail</h2>
          <p class="page-subtitle">Configuration de l'acc√®s √† votre bo√Æte mail d√©di√©e</p>
        </div>
      </div>
      <div id="settings-content"></div>
    </div>

  </main>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-add-apt">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Nouvel appartement</h3>
      <button class="btn-icon" onclick="closeModal('modal-add-apt')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Nom / R√©f√©rence</label><input type="text" class="form-input" id="new-apt-name" placeholder="ex: Appt Bellecour T2"></div>
        <div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="new-apt-status"><option value="disponible">Disponible</option><option value="en-cours">En cours</option><option value="loue">Lou√©</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Adresse compl√®te</label><input type="text" class="form-input" id="new-apt-address" placeholder="ex: 12 rue Victor Hugo, Lyon 69002"></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Loyer (‚Ç¨/mois CC)</label><input type="number" class="form-input" id="new-apt-price" placeholder="850"></div>
        <div class="form-group"><label class="form-label">Surface (m¬≤)</label><input type="number" class="form-input" id="new-apt-surface" placeholder="45"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Pi√®ces</label><input type="number" class="form-input" id="new-apt-rooms" placeholder="2" min="1"></div>
        <div class="form-group"><label class="form-label">√âtage</label><input type="text" class="form-input" id="new-apt-floor" placeholder="ex: 3√®me, RDC"></div>
      </div>
      <div class="form-group"><label class="form-label">Description annonce LeBonCoin</label><textarea class="form-textarea" id="new-apt-desc" placeholder="Appartement meubl√©, lumineux‚Ä¶"></textarea></div>
      <div class="form-group"><label class="form-label">Lien annonce LeBonCoin</label><input type="url" class="form-input" id="new-apt-url" placeholder="https://www.leboncoin.fr/‚Ä¶"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-add-apt')">Annuler</button>
      <button class="btn btn-primary" onclick="addApartment()">Cr√©er</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-candidate">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Ajouter un candidat</h3>
      <button class="btn-icon" onclick="closeModal('modal-add-candidate')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Pr√©nom & Nom</label><input type="text" class="form-input" id="new-cand-name" placeholder="Marie Dupont"></div>
        <div class="form-group"><label class="form-label">Statut</label><select class="form-select" id="new-cand-status"><option value="nouveau">Nouveau contact</option><option value="fiche-envoyee">Fiche envoy√©e</option><option value="visite">Visite planifi√©e</option><option value="refuse">Non retenu</option></select></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">T√©l√©phone</label><input type="tel" class="form-input" id="new-cand-phone" placeholder="06 XX XX XX XX"></div>
        <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-input" id="new-cand-email" placeholder="exemple@mail.fr"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Situation pro</label><input type="text" class="form-input" id="new-cand-job" placeholder="CDI, fonctionnaire‚Ä¶"></div>
        <div class="form-group"><label class="form-label">Revenus nets/mois (‚Ç¨)</label><input type="number" class="form-input" id="new-cand-income" placeholder="2000"></div>
      </div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="new-cand-notes" style="min-height:70px" placeholder="Impressions, informations‚Ä¶"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-add-candidate')">Annuler</button>
      <button class="btn btn-primary" onclick="addCandidate()">Ajouter</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-msg">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Nouveau message type</h3>
      <button class="btn-icon" onclick="closeModal('modal-add-msg')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Titre</label><input type="text" class="form-input" id="new-msg-title" placeholder="ex: Premier contact"></div>
      <div class="form-group"><label class="form-label">Contenu</label><textarea class="form-textarea" id="new-msg-content" style="min-height:150px" placeholder="Bonjour,‚Ä¶"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('modal-add-msg')">Annuler</button>
      <button class="btn btn-primary" onclick="addMessage()">Enregistrer</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// DATA STORE
// ============================================================
let appData = {
  apartments: [
    { id: 1, name: "Appartement T2 Centre", address: "12 rue de la Paix, Lyon 69001", status: "disponible", price: 750, surface: 38, rooms: 2, floor: "2√®me", desc: "Bel appartement meubl√© T2 en plein centre-ville. Lumineux, calme, tout √©quip√©. Proche transports et commerces. Parfait pour jeune actif ou couple. Lou√© meubl√© charges comprises.", url: "", photos: [], candidates: [
      { id: 1, name: "Sophie Martin", status: "fiche-envoyee", phone: "06 12 34 56 78", email: "sophie.martin@gmail.com", job: "CDI ‚Äì Infirmi√®re", income: 2100, notes: "S√©rieuse, bonne pr√©sentation" },
      { id: 2, name: "Thomas Leroy", status: "nouveau", phone: "07 98 76 54 32", email: "t.leroy@outlook.fr", job: "CDD ‚Äì Ing√©nieur", income: 2400, notes: "" }
    ]},
    { id: 2, name: "Studio Vieux-Lyon", address: "8 rue Saint-Jean, Lyon 69005", status: "loue", price: 620, surface: 25, rooms: 1, floor: "1er", desc: "Charmant studio meubl√© dans le Vieux-Lyon class√© UNESCO. Pierres apparentes, poutres, tout confort. √Ä deux pas de la Sa√¥ne.", url: "", photos: [], candidates: [] },
    { id: 3, name: "T3 Croix-Rousse", address: "45 bd de la Croix-Rousse, Lyon 69004", status: "en-cours", price: 980, surface: 62, rooms: 3, floor: "4√®me", desc: "Grand T3 meubl√© au c≈ìur du quartier des canuts. Vue d√©gag√©e, parquet ancien, cuisine √©quip√©e. Proche boulangeries, march√©s, transports.", url: "", photos: [], candidates: [
      { id: 1, name: "Camille Bernard", status: "visite", phone: "06 55 44 33 22", email: "c.bernard@pro.fr", job: "Fonctionnaire", income: 2800, notes: "Visite samedi 10h" }
    ]},
    { id: 4, name: "T2 Part-Dieu", address: "18 rue Garibaldi, Lyon 69003", status: "disponible", price: 820, surface: 42, rooms: 2, floor: "5√®me", desc: "T2 meubl√© moderne, proche gare Part-Dieu. Id√©al pour professionnels. Cuisine ouverte, double vitrage, ascenseur.", url: "", photos: [], candidates: [] }
  ],
  messages: [
    { id: 1, title: "Premier contact ‚Äì Disponibilit√©", content: "Bonjour,\n\nL'appartement est disponible. Envoyez-moi votre e-mail par message sur mon t√©l√©phone portable et je vous ferai suivre une fiche √† remplir pour d√©finir d'une visite.\n\nIl est lou√© meubl√©.\n\nMerci." },
    { id: 2, title: "Envoi de la fiche candidat", content: "Bonjour,\n\nSuite √† votre prise de contact, veuillez trouver ci-joint la fiche √† compl√©ter afin que nous puissions planifier une visite.\n\nMerci de me la retourner compl√©t√©e.\n\nCordialement." },
    { id: 3, title: "Confirmation de visite", content: "Bonjour,\n\nJ'ai bien re√ßu votre dossier. Je vous propose une visite le [DATE] √† [HEURE].\n\nAdresse : [ADRESSE].\n\nMerci de confirmer votre disponibilit√©.\n\nCordialement." },
    { id: 4, title: "Suite n√©gative", content: "Bonjour,\n\nJe vous remercie de l'int√©r√™t port√© √† l'appartement.\n\nApr√®s √©tude des dossiers, je n'ai pas pu donner suite √† votre candidature.\n\nBonne chance dans vos recherches.\n\nCordialement." }
  ],
  gmail: {
    configured: false,
    clientId: '',
    email: '',
    accessToken: null,
    tokenExpiry: null
  },
  currentAptId: null,
  currentEmailId: null,
  composeDefaults: {}
};

// Persist to localStorage
function saveData() {
  const toSave = { ...appData, gmail: { ...appData.gmail, accessToken: null } };
  localStorage.setItem('gestion_locative_v2', JSON.stringify(toSave));
}
function loadData() {
  const saved = localStorage.getItem('gestion_locative_v2');
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      appData = { ...appData, ...parsed };
    } catch(e) {}
  }
}
loadData();

// ============================================================
// NAVIGATION
// ============================================================
function showPage(page, id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => {
    if (n.getAttribute('onclick') && n.getAttribute('onclick').includes(`'${page}'`)) n.classList.add('active');
  });

  if (page === 'dashboard') renderDashboard();
  if (page === 'appartements') renderAptsList();
  if (page === 'apt-detail' && id) { appData.currentAptId = id; renderAptDetail(id); }
  if (page === 'gmail') renderGmailPage();
  if (page === 'email-detail' && id) { appData.currentEmailId = id; }
  if (page === 'compose') renderCompose();
  if (page === 'messages') renderMessages();
  if (page === 'fiche') renderFiche();
  if (page === 'settings') renderSettings();
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const apts = appData.apartments;
  const available = apts.filter(a => a.status === 'disponible').length;
  const rented = apts.filter(a => a.status === 'loue').length;
  const totalCandidates = apts.reduce((s, a) => s + a.candidates.length, 0);
  const today = new Date().toLocaleDateString('fr-FR', { weekday:'long', day:'numeric', month:'long' });
  document.getElementById('dash-subtitle').textContent = today.charAt(0).toUpperCase() + today.slice(1);
  document.getElementById('footer-apt-count').textContent = apts.length;
  document.getElementById('footer-cand-count').textContent = totalCandidates;
  document.getElementById('nav-count').textContent = apts.length;

  document.getElementById('stats-bar').innerHTML = `
    <div class="stat-card"><div class="stat-value">${apts.length}</div><div class="stat-label">Appartements</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--sage)">${available}</div><div class="stat-label">Disponibles</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--terracotta)">${rented}</div><div class="stat-label">Lou√©s</div></div>
    <div class="stat-card"><div class="stat-value" style="color:var(--gold)">${totalCandidates}</div><div class="stat-label">Candidats</div></div>
  `;
  document.getElementById('dashboard-cards').innerHTML = apts.map(renderAptCard).join('');
  updateGmailStatusIndicator();
}

function renderAptCard(apt) {
  const sl = { disponible: 'Disponible', loue: 'Lou√©', 'en-cours': 'En cours' };
  return `<div class="apt-card" onclick="showPage('apt-detail', ${apt.id})">
    <div class="apt-card-img">
      ${apt.photos.length > 0 ? `<img src="${apt.photos[0]}" alt="">` : `<div class="no-photo"><span>üè†</span><p>Ajouter des photos</p></div>`}
      <span class="apt-status-badge status-${apt.status}">${sl[apt.status]}</span>
    </div>
    <div class="apt-card-body">
      <div class="apt-card-title">${apt.name}</div>
      <div class="apt-card-meta"><span>üìç ${apt.address.split(',').slice(-1)[0].trim()}</span><span>üìê ${apt.surface}m¬≤</span><span>üö™ ${apt.rooms}P</span></div>
    </div>
    <div class="apt-card-footer">
      <span class="candidate-count">üë§ ${apt.candidates.length} candidat${apt.candidates.length !== 1 ? 's' : ''}</span>
      <span class="apt-price">${apt.price}‚Ç¨/mois</span>
    </div>
  </div>`;
}

function renderAptsList() {
  document.getElementById('apts-list-cards').innerHTML = appData.apartments.map(renderAptCard).join('');
}

// ============================================================
// APT DETAIL
// ============================================================
function renderAptDetail(aptId) {
  const apt = appData.apartments.find(a => a.id === aptId);
  if (!apt) return;
  const sl = { disponible: 'Disponible', loue: 'Lou√©', 'en-cours': 'En cours' };
  document.getElementById('apt-detail-content').innerHTML = `
    <div class="apt-detail-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;position:relative;z-index:1">
        <div>
          <div class="apt-detail-name">${apt.name}</div>
          <div class="apt-detail-address">üìç ${apt.address}</div>
          <div class="apt-detail-meta">
            <div class="apt-detail-meta-item"><strong>${apt.price}‚Ç¨/mois</strong>Loyer CC</div>
            <div class="apt-detail-meta-item"><strong>${apt.surface} m¬≤</strong>Surface</div>
            <div class="apt-detail-meta-item"><strong>${apt.rooms} pi√®ces</strong>Type</div>
            <div class="apt-detail-meta-item"><strong>${apt.floor}</strong>√âtage</div>
          </div>
        </div>
        <span class="apt-status-badge status-${apt.status}">${sl[apt.status]}</span>
      </div>
    </div>
    <div class="tabs">
      <button class="tab active" onclick="switchTab(this,'tab-annonce-${aptId}')">üìù Annonce</button>
      <button class="tab" onclick="switchTab(this,'tab-photos-${aptId}')">üì∏ Photos</button>
      <button class="tab" onclick="switchTab(this,'tab-candidats-${aptId}')">üë§ Candidats (${apt.candidates.length})</button>
    </div>
    <div class="tab-panel active" id="tab-annonce-${aptId}">
      <div class="template-box">
        <div class="template-header">
          <span class="template-label">‚úèÔ∏è Texte LeBonCoin</span>
          <div class="template-actions">
            <button class="copy-btn" onclick="copyText(appData.apartments.find(a=>a.id===${aptId}).desc)">üìã Copier</button>
            <button class="btn-icon" onclick="editAnnonce(${aptId})">‚úèÔ∏è</button>
          </div>
        </div>
        <div class="template-content" id="annonce-text-${aptId}">${apt.desc || '(Aucune description)'}</div>
      </div>
      ${apt.url ? `<a href="${apt.url}" target="_blank" class="btn btn-secondary btn-sm">üîó Voir sur LeBonCoin</a>` : ''}
    </div>
    <div class="tab-panel" id="tab-photos-${aptId}">
      <div class="photo-grid" id="photo-grid-${aptId}">
        ${apt.photos.map((p, i) => `<div class="photo-thumb"><img src="${p}"><button class="photo-delete" onclick="deletePhoto(${aptId},${i})">‚úï</button></div>`).join('')}
        <label class="photo-add"><span class="plus">+</span><span>Ajouter</span><input type="file" accept="image/*" multiple style="display:none" onchange="addPhotos(${aptId},this)"></label>
      </div>
    </div>
    <div class="tab-panel" id="tab-candidats-${aptId}">
      <div class="section-header">
        <h3 class="section-title">Candidats</h3>
        <button class="btn btn-primary btn-sm" onclick="openAddCandidate(${aptId})">+ Candidat</button>
      </div>
      <div id="candidates-list-${aptId}">${renderCandidatesHTML(apt)}</div>
    </div>
  `;
}

function renderCandidatesHTML(apt) {
  if (apt.candidates.length === 0) return `<div class="empty-state"><span class="big-icon">üë§</span><p>Aucun candidat pour l'instant.</p><button class="btn btn-primary btn-sm" onclick="openAddCandidate(${apt.id})">Ajouter un candidat</button></div>`;
  const sl = { nouveau: 'Nouveau', 'fiche-envoyee': 'Fiche envoy√©e', visite: 'Visite planifi√©e', refuse: 'Non retenu' };
  return apt.candidates.map(c => `
    <div class="candidate-item">
      <div class="candidate-row">
        <div class="candidate-avatar">${c.name.charAt(0)}</div>
        <div class="candidate-info">
          <div class="candidate-name">${c.name}</div>
          <div class="candidate-detail">${[c.phone, c.email, c.job, c.income ? c.income+'‚Ç¨/mois' : ''].filter(Boolean).join(' ¬∑ ')}</div>
          ${c.notes ? `<div class="candidate-detail" style="font-style:italic;margin-top:2px">${c.notes}</div>` : ''}
        </div>
        <span class="candidate-status cstatus-${c.status}">${sl[c.status]||c.status}</span>
        <div class="candidate-actions">
          ${c.email && appData.gmail.configured ? `<button class="btn-icon" title="Envoyer un email" onclick="composeToCandidate('${c.email}','${c.name}',${apt.id})">üìß</button>` : ''}
          <button class="btn-icon" style="color:#E74C3C" onclick="removeCandidate(${apt.id},${c.id})">üóë</button>
        </div>
      </div>
    </div>
  `).join('');
}

// ============================================================
// GMAIL INTEGRATION
// ============================================================
const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.modify';
let tokenClient = null;
let gmailEmails = [];

function updateGmailStatusIndicator() {
  const ind = document.getElementById('gmail-status-indicator');
  const txt = document.getElementById('gmail-status-text');
  const email = document.getElementById('gmail-status-email');
  if (appData.gmail.configured && appData.gmail.accessToken) {
    ind.className = 'gmail-status connected';
    txt.textContent = 'Gmail connect√©';
    email.textContent = appData.gmail.email || '';
  } else if (appData.gmail.configured) {
    ind.className = 'gmail-status disconnected';
    txt.textContent = 'Gmail configur√©';
    email.textContent = 'Reconnexion requise';
  } else {
    ind.className = 'gmail-status disconnected';
    txt.textContent = 'Gmail non connect√©';
    email.textContent = 'Cliquer pour configurer';
  }
}

function initGapiClient() {
  return new Promise((resolve, reject) => {
    if (!appData.gmail.clientId) { reject('No clientId'); return; }
    gapi.load('client', async () => {
      try {
        await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'] });
        resolve();
      } catch(e) { reject(e); }
    });
  });
}

function initTokenClient() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: appData.gmail.clientId,
    scope: GMAIL_SCOPES,
    callback: (response) => {
      if (response.error) { showToast('Erreur OAuth : ' + response.error, true); return; }
      appData.gmail.accessToken = response.access_token;
      appData.gmail.tokenExpiry = Date.now() + (response.expires_in * 1000);
      gapi.client.setToken({ access_token: response.access_token });
      updateGmailStatusIndicator();
      showToast('‚úÖ Gmail connect√© !');
      loadInbox();
      saveData();
    }
  });
}

async function connectGmail() {
  if (!appData.gmail.clientId) { showToast('Configurez d\'abord votre Client ID', true); showPage('settings'); return; }
  try {
    await loadGoogleScripts();
    await initGapiClient();
    initTokenClient();
    tokenClient.requestAccessToken({ prompt: 'consent' });
  } catch(e) {
    showToast('Erreur : ' + e.message, true);
  }
}

function loadGoogleScripts() {
  return new Promise((resolve) => {
    const gapiLoaded = typeof gapi !== 'undefined';
    const gisLoaded = typeof google !== 'undefined' && google.accounts;
    if (gapiLoaded && gisLoaded) { resolve(); return; }

    let loaded = 0;
    const check = () => { if (++loaded === 2) resolve(); };

    if (!gapiLoaded) {
      const s = document.createElement('script');
      s.src = 'https://apis.google.com/js/api.js';
      s.onload = check;
      document.head.appendChild(s);
    } else check();

    if (!gisLoaded) {
      const s = document.createElement('script');
      s.src = 'https://accounts.google.com/gsi/client';
      s.onload = check;
      document.head.appendChild(s);
    } else check();
  });
}

async function loadInbox() {
  if (!appData.gmail.configured || !appData.gmail.accessToken) {
    renderGmailPage();
    return;
  }
  document.getElementById('gmail-page-content').innerHTML = `<div class="loading"><div class="spinner"></div> Chargement des emails‚Ä¶</div>`;
  try {
    await loadGoogleScripts();
    if (!gapi.client.gmail) await initGapiClient();
    gapi.client.setToken({ access_token: appData.gmail.accessToken });

    const res = await gapi.client.gmail.users.messages.list({
      userId: 'me', maxResults: 30, labelIds: ['INBOX']
    });
    const messages = res.result.messages || [];
    gmailEmails = [];

    await Promise.all(messages.slice(0, 20).map(async (msg) => {
      const detail = await gapi.client.gmail.users.messages.get({
        userId: 'me', id: msg.id, format: 'metadata',
        metadataHeaders: ['From', 'Subject', 'Date']
      });
      const headers = detail.result.payload.headers;
      const get = (name) => (headers.find(h => h.name === name) || {}).value || '';
      const unread = detail.result.labelIds && detail.result.labelIds.includes('UNREAD');
      gmailEmails.push({
        id: msg.id,
        from: get('From'),
        subject: get('Subject') || '(sans objet)',
        date: get('Date'),
        snippet: detail.result.snippet || '',
        unread,
        threadId: detail.result.threadId
      });
    }));

    gmailEmails.sort((a, b) => new Date(b.date) - new Date(a.date));
    const unreadCount = gmailEmails.filter(e => e.unread).length;
    const badge = document.getElementById('unread-badge');
    if (unreadCount > 0) { badge.textContent = unreadCount; badge.style.display = ''; }
    else badge.style.display = 'none';

    renderInbox();
  } catch(e) {
    if (e.status === 401) {
      appData.gmail.accessToken = null;
      updateGmailStatusIndicator();
      renderGmailPage();
    } else {
      document.getElementById('gmail-page-content').innerHTML = `<div class="empty-state"><span class="big-icon">‚ö†Ô∏è</span><p>Erreur lors du chargement : ${e.message || e}</p><button class="btn btn-primary" onclick="loadInbox()">R√©essayer</button></div>`;
    }
  }
}

function renderGmailPage() {
  const container = document.getElementById('gmail-page-content');
  if (!appData.gmail.configured) {
    container.innerHTML = `
      <div class="gmail-connect-banner">
        <span class="big-icon">üìß</span>
        <h3>Connectez votre adresse Gmail d√©di√©e</h3>
        <p>Lisez et envoyez des emails directement depuis cette application. Configurez votre adresse Gmail en quelques minutes.</p>
        <button class="btn btn-gmail" onclick="showPage('settings')">‚öôÔ∏è Configurer Gmail</button>
      </div>
      <div class="info-box"><strong>Pourquoi une configuration est n√©cessaire ?</strong>Pour acc√©der √† Gmail depuis une application externe, Google requiert une cl√© API. La configuration prend environ 10 minutes et se fait une seule fois. Consultez le guide dans Param√®tres.</div>
    `;
    return;
  }
  if (!appData.gmail.accessToken) {
    container.innerHTML = `
      <div class="gmail-connect-banner">
        <span class="big-icon">üîë</span>
        <h3>Reconnexion requise</h3>
        <p>Votre session Gmail a expir√©. Reconnectez-vous pour acc√©der √† votre bo√Æte mail.</p>
        <button class="btn btn-gmail" onclick="connectGmail()">Se connecter avec Google</button>
      </div>
    `;
    return;
  }
  loadInbox();
}

function renderInbox() {
  const container = document.getElementById('gmail-page-content');
  if (gmailEmails.length === 0) {
    container.innerHTML = `<div class="empty-state"><span class="big-icon">üì≠</span><p>Bo√Æte de r√©ception vide.</p></div>`;
    return;
  }
  container.innerHTML = `
    <div class="email-toolbar">
      <input type="text" class="email-search" placeholder="üîç Rechercher dans les emails‚Ä¶" oninput="filterEmails(this.value)">
    </div>
    <div id="email-list">${gmailEmails.map(renderEmailItem).join('')}</div>
  `;
}

function renderEmailItem(email) {
  const fromName = email.from.split('<')[0].trim().replace(/"/g,'') || email.from;
  const initial = fromName.charAt(0).toUpperCase();
  const dateStr = formatEmailDate(email.date);
  const aptTag = guessApartmentFromEmail(email);
  return `
    <div class="email-item ${email.unread ? 'unread' : ''}" onclick="openEmail('${email.id}')">
      <div class="email-avatar">${initial}</div>
      <div class="email-content">
        <div class="email-from">${fromName}</div>
        <div class="email-subject">${email.subject}</div>
        <div class="email-preview">${email.snippet}</div>
      </div>
      <div class="email-meta">
        <div class="email-date">${dateStr}</div>
        ${aptTag ? `<div class="email-apt-tag">${aptTag}</div>` : ''}
      </div>
    </div>
  `;
}

function guessApartmentFromEmail(email) {
  const text = (email.subject + ' ' + email.snippet).toLowerCase();
  for (const apt of appData.apartments) {
    const words = apt.name.toLowerCase().split(' ');
    if (words.some(w => w.length > 3 && text.includes(w))) return apt.name.substring(0, 18) + (apt.name.length > 18 ? '‚Ä¶' : '');
  }
  return null;
}

function formatEmailDate(dateStr) {
  try {
    const d = new Date(dateStr);
    const now = new Date();
    const diffDays = Math.floor((now - d) / 86400000);
    if (diffDays === 0) return d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
    if (diffDays === 1) return 'Hier';
    if (diffDays < 7) return d.toLocaleDateString('fr-FR', { weekday: 'short' });
    return d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
  } catch { return ''; }
}

function filterEmails(query) {
  const q = query.toLowerCase();
  const filtered = gmailEmails.filter(e =>
    e.from.toLowerCase().includes(q) || e.subject.toLowerCase().includes(q) || e.snippet.toLowerCase().includes(q)
  );
  document.getElementById('email-list').innerHTML = filtered.map(renderEmailItem).join('');
}

async function openEmail(emailId) {
  showPage('email-detail');
  document.getElementById('email-detail-content').innerHTML = `<div class="loading"><div class="spinner"></div> Chargement‚Ä¶</div>`;
  try {
    gapi.client.setToken({ access_token: appData.gmail.accessToken });
    const res = await gapi.client.gmail.users.messages.get({ userId: 'me', id: emailId, format: 'full' });
    const msg = res.result;
    const headers = msg.payload.headers;
    const get = (name) => (headers.find(h => h.name === name) || {}).value || '';

    // Mark as read
    await gapi.client.gmail.users.messages.modify({ userId: 'me', id: emailId, resource: { removeLabelIds: ['UNREAD'] } });

    // Get body
    let body = '';
    const extractBody = (part) => {
      if (part.mimeType === 'text/plain' && part.body.data) {
        body = atob(part.body.data.replace(/-/g, '+').replace(/_/g, '/'));
      } else if (part.parts) part.parts.forEach(extractBody);
    };
    if (msg.payload.body && msg.payload.body.data) {
      body = atob(msg.payload.body.data.replace(/-/g, '+').replace(/_/g, '/'));
    } else if (msg.payload.parts) msg.payload.parts.forEach(extractBody);

    const from = get('From');
    const fromName = from.split('<')[0].trim().replace(/"/g,'');
    const fromEmail = (from.match(/<(.+)>/) || [,''])[1] || from;

    document.getElementById('email-detail-content').innerHTML = `
      <div class="email-detail">
        <div class="email-detail-header">
          <div class="email-detail-subject">${get('Subject') || '(sans objet)'}</div>
          <div class="email-detail-meta">
            <span>De : <strong>${fromName}</strong> &lt;${fromEmail}&gt;</span>
            <span>Le : ${new Date(get('Date')).toLocaleString('fr-FR')}</span>
          </div>
        </div>
        <div class="email-detail-body">${escapeHtml(body) || '<em style="color:var(--text-muted)">Corps du message non disponible en texte brut.</em>'}</div>
        <div class="email-detail-actions">
          <button class="btn btn-primary" onclick="composeReply('${escapeAttr(fromEmail)}','${escapeAttr(fromName)}','${escapeAttr(get('Subject'))}')">‚Ü© R√©pondre</button>
          <button class="btn btn-secondary" onclick="composeToCandidate('${escapeAttr(fromEmail)}','${escapeAttr(fromName)}',null)">üìù Avec message type</button>
          <button class="btn btn-ghost" onclick="showPage('gmail')">‚Üê Retour</button>
        </div>
      </div>
    `;

    // Update unread count
    const emailInList = gmailEmails.find(e => e.id === emailId);
    if (emailInList) emailInList.unread = false;
    const unreadCount = gmailEmails.filter(e => e.unread).length;
    const badge = document.getElementById('unread-badge');
    if (unreadCount > 0) { badge.textContent = unreadCount; badge.style.display = ''; } else badge.style.display = 'none';

  } catch(e) {
    document.getElementById('email-detail-content').innerHTML = `<div class="empty-state"><span class="big-icon">‚ö†Ô∏è</span><p>Erreur : ${e.message}</p></div>`;
  }
}

// ============================================================
// COMPOSE
// ============================================================
function renderCompose(defaults = {}) {
  const d = { ...appData.composeDefaults, ...defaults };
  const msgs = appData.messages;

  if (!appData.gmail.configured || !appData.gmail.accessToken) {
    document.getElementById('compose-content').innerHTML = `
      <div class="gmail-connect-banner">
        <span class="big-icon">‚úçÔ∏è</span>
        <h3>Gmail requis pour envoyer</h3>
        <p>Connectez votre adresse Gmail d√©di√©e pour pouvoir envoyer des emails depuis l'application.</p>
        <button class="btn btn-gmail" onclick="showPage('settings')">‚öôÔ∏è Configurer Gmail</button>
      </div>
    `;
    return;
  }

  document.getElementById('compose-content').innerHTML = `
    <div class="compose-box">
      <div class="compose-header">
        <span>üìß Nouveau message ‚Äî ${appData.gmail.email}</span>
      </div>
      <div class="compose-body">
        <div class="compose-field"><label>√Ä</label><input type="email" id="compose-to" value="${escapeAttr(d.to||'')}" placeholder="destinataire@email.fr"></div>
        <div class="compose-field"><label>Objet</label><input type="text" id="compose-subject" value="${escapeAttr(d.subject||'')}" placeholder="Objet du message‚Ä¶"></div>
        <textarea class="compose-textarea" id="compose-body" placeholder="√âcrivez votre message‚Ä¶">${d.body||''}</textarea>
      </div>
      <div class="compose-footer">
        <button class="btn btn-primary" onclick="sendEmail()">üì§ Envoyer</button>
        <button class="btn btn-ghost" id="btn-insert-template" onclick="toggleTemplateSelector()">üí¨ Ins√©rer un mod√®le</button>
        <button class="btn btn-ghost" onclick="document.getElementById('compose-body').value=''">üóë Effacer</button>
      </div>
    </div>
    <div id="template-selector" style="display:none">
      <div class="section-header" style="margin-bottom:10px"><h3 class="section-title" style="font-size:1rem">Choisir un message type</h3></div>
      ${msgs.map(m => `
        <div class="template-box" style="cursor:pointer;margin-bottom:8px" onclick="insertTemplate(${m.id})">
          <div class="template-header"><span class="template-label">${m.title}</span><span style="font-size:0.75rem;color:var(--terracotta)">Ins√©rer ‚Üí</span></div>
          <div class="template-content" style="font-size:0.8rem">${m.content.substring(0, 100)}‚Ä¶</div>
        </div>
      `).join('')}
    </div>
  `;
}

function toggleTemplateSelector() {
  const el = document.getElementById('template-selector');
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

function insertTemplate(msgId) {
  const msg = appData.messages.find(m => m.id === msgId);
  if (!msg) return;
  document.getElementById('compose-body').value = msg.content;
  document.getElementById('template-selector').style.display = 'none';
  if (!document.getElementById('compose-subject').value) {
    document.getElementById('compose-subject').value = msg.title;
  }
}

function composeToCandidate(email, name, aptId) {
  appData.composeDefaults = { to: email, subject: `Location ‚Äì ${aptId ? appData.apartments.find(a=>a.id===aptId)?.name || '' : ''}` };
  showPage('compose');
  renderCompose(appData.composeDefaults);
}

function composeReply(email, name, subject) {
  const re = subject.startsWith('Re:') ? subject : 'Re: ' + subject;
  appData.composeDefaults = { to: email, subject: re };
  showPage('compose');
  renderCompose(appData.composeDefaults);
}

async function sendEmail() {
  const to = document.getElementById('compose-to').value.trim();
  const subject = document.getElementById('compose-subject').value.trim();
  const body = document.getElementById('compose-body').value.trim();
  if (!to || !body) { showToast('Destinataire et message requis', true); return; }

  try {
    gapi.client.setToken({ access_token: appData.gmail.accessToken });
    const raw = makeEmailRaw(appData.gmail.email, to, subject, body);
    await gapi.client.gmail.users.messages.send({ userId: 'me', resource: { raw } });
    showToast('‚úÖ Email envoy√© !');
    document.getElementById('compose-to').value = '';
    document.getElementById('compose-subject').value = '';
    document.getElementById('compose-body').value = '';
  } catch(e) {
    showToast('Erreur envoi : ' + (e.result?.error?.message || e.message), true);
  }
}

function makeEmailRaw(from, to, subject, body) {
  const email = [`From: ${from}`, `To: ${to}`, `Subject: =?UTF-8?B?${btoa(unescape(encodeURIComponent(subject)))}?=`, 'MIME-Version: 1.0', 'Content-Type: text/plain; charset=UTF-8', '', body].join('\r\n');
  return btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}

// ============================================================
// SETTINGS PAGE
// ============================================================
function renderSettings() {
  document.getElementById('settings-content').innerHTML = `
    <div class="info-box">
      <strong>üîí Vos cl√©s API ne quittent jamais votre navigateur</strong>
      Elles sont stock√©es localement et ne transitent par aucun serveur tiers.
    </div>

    <!-- Configuration form -->
    <div class="section">
      <div class="section-header"><h3 class="section-title">üîß Identifiants Google API</h3></div>
      <div class="template-box">
        <div class="form-group">
          <label class="form-label">Client ID Google OAuth 2.0</label>
          <input type="text" class="form-input" id="settings-client-id" value="${appData.gmail.clientId || ''}" placeholder="XXXXXXXX.apps.googleusercontent.com">
        </div>
        <div class="form-group">
          <label class="form-label">Adresse email d√©di√©e</label>
          <input type="email" class="form-input" id="settings-email" value="${appData.gmail.email || ''}" placeholder="mes.locations@gmail.com">
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="saveGmailSettings()">üíæ Enregistrer</button>
          ${appData.gmail.configured ? `<button class="btn btn-gmail" onclick="connectGmail()">üîë Se connecter √† Gmail</button>` : ''}
          ${appData.gmail.accessToken ? `<button class="btn btn-secondary" onclick="disconnectGmail()">Se d√©connecter</button>` : ''}
        </div>
      </div>
    </div>

    <!-- Step-by-step guide -->
    <div class="section">
      <div class="section-header"><h3 class="section-title">üìñ Guide de configuration (10 min)</h3></div>

      <div class="setup-step">
        <div class="step-number">1</div>
        <div class="step-content">
          <h4>Cr√©er un compte Google d√©di√©</h4>
          <p>Rendez-vous sur <a href="https://accounts.google.com/signup" target="_blank">accounts.google.com/signup</a> et cr√©ez une nouvelle adresse Gmail. Exemple : <code>mes.locations.2024@gmail.com</code></p>
        </div>
      </div>

      <div class="setup-step">
        <div class="step-number">2</div>
        <div class="step-content">
          <h4>Acc√©der √† Google Cloud Console</h4>
          <p>Connect√© avec ce nouveau compte, allez sur <a href="https://console.cloud.google.com" target="_blank">console.cloud.google.com</a> ‚Üí Cr√©ez un nouveau projet (ex: "Gestion Locative").</p>
        </div>
      </div>

      <div class="setup-step">
        <div class="step-number">3</div>
        <div class="step-content">
          <h4>Activer l'API Gmail</h4>
          <p>Dans le menu ‚Üí <em>API et services</em> ‚Üí <em>Biblioth√®que</em> ‚Üí cherchez "Gmail API" ‚Üí cliquez <strong>Activer</strong>.</p>
        </div>
      </div>

      <div class="setup-step">
        <div class="step-number">4</div>
        <div class="step-content">
          <h4>Cr√©er les identifiants OAuth</h4>
          <p><em>API et services</em> ‚Üí <em>Identifiants</em> ‚Üí <em>Cr√©er des identifiants</em> ‚Üí <strong>ID client OAuth 2.0</strong>.<br>
          Type d'application : <strong>Application Web</strong>.<br>
          Dans <em>"Origines JavaScript autoris√©es"</em>, ajoutez : <code>file://</code> et l'URL de la page si h√©berg√©e.<br>
          Copiez le <strong>Client ID</strong> g√©n√©r√©.</p>
        </div>
      </div>

      <div class="setup-step">
        <div class="step-number">5</div>
        <div class="step-content">
          <h4>Configurer l'√©cran de consentement</h4>
          <p><em>API et services</em> ‚Üí <em>√âcran de consentement OAuth</em> ‚Üí Type : <strong>Externe</strong>. Remplissez le nom de l'app (ex: "Mes Locations"). Dans <em>Utilisateurs test</em>, ajoutez votre adresse d√©di√©e.</p>
        </div>
      </div>

      <div class="setup-step">
        <div class="step-number">6</div>
        <div class="step-content">
          <h4>Coller le Client ID ici</h4>
          <p>Revenez dans cette page, collez votre <strong>Client ID</strong> dans le champ ci-dessus avec votre adresse d√©di√©e, puis cliquez <strong>Enregistrer</strong>, puis <strong>Se connecter √† Gmail</strong>.</p>
        </div>
      </div>
    </div>
  `;
}

function saveGmailSettings() {
  const clientId = document.getElementById('settings-client-id').value.trim();
  const email = document.getElementById('settings-email').value.trim();
  if (!clientId || !email) { showToast('Remplissez les deux champs', true); return; }
  appData.gmail.clientId = clientId;
  appData.gmail.email = email;
  appData.gmail.configured = true;
  saveData();
  updateGmailStatusIndicator();
  showToast('‚úÖ Param√®tres enregistr√©s !');
  renderSettings();
}

function disconnectGmail() {
  appData.gmail.accessToken = null;
  appData.gmail.tokenExpiry = null;
  updateGmailStatusIndicator();
  saveData();
  showToast('D√©connect√© de Gmail');
  renderSettings();
}

// ============================================================
// MESSAGES
// ============================================================
function renderMessages() {
  const list = document.getElementById('messages-list');
  if (!appData.messages.length) { list.innerHTML = `<div class="empty-state"><span class="big-icon">üí¨</span><p>Aucun message type.</p></div>`; return; }
  list.innerHTML = appData.messages.map(m => `
    <div class="template-box">
      <div class="template-header">
        <span class="template-label">üí¨ ${m.title}</span>
        <div class="template-actions">
          <button class="copy-btn" onclick="copyText(appData.messages.find(x=>x.id===${m.id}).content)">üìã Copier</button>
          ${appData.gmail.configured && appData.gmail.accessToken ? `<button class="btn btn-gmail btn-sm" onclick="composeWithTemplate(${m.id})">üìß Envoyer</button>` : ''}
          <button class="btn-icon" onclick="deleteMessage(${m.id})" style="color:#E74C3C">üóë</button>
        </div>
      </div>
      <div class="template-content">${m.content}</div>
    </div>
  `).join('');
}

function composeWithTemplate(msgId) {
  const msg = appData.messages.find(m => m.id === msgId);
  if (!msg) return;
  appData.composeDefaults = { subject: msg.title, body: msg.content };
  showPage('compose');
}

// ============================================================
// FICHE
// ============================================================
function renderFiche() {
  document.getElementById('fiche-content').innerHTML = `
    <h3>üè† Fiche Candidature ‚Äì Location meubl√©e</h3>
    <div class="fiche-section-title">Appartement concern√©</div>
    <div class="fiche-field"><label>R√©f√©rence / Adresse</label><div class="fiche-line"></div></div>
    <div class="fiche-section-title">Informations personnelles</div>
    <div class="fiche-field"><label>Nom & Pr√©nom</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Date de naissance</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Adresse actuelle</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>T√©l√©phone</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Email</label><div class="fiche-line"></div></div>
    <div class="fiche-section-title">Situation professionnelle</div>
    <div class="fiche-field"><label>Statut / Contrat</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Employeur</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Poste occup√©</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Anciennet√©</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Revenus nets mensuels</label><div class="fiche-line"></div></div>
    <div class="fiche-section-title">Garant (si applicable)</div>
    <div class="fiche-field"><label>Nom & Pr√©nom garant</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Lien avec le candidat</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Revenus nets garant</label><div class="fiche-line"></div></div>
    <div class="fiche-section-title">Situation locative</div>
    <div class="fiche-field"><label>Locataire actuel ?</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Date souhait√©e d'emm√©nagement</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Nombre d'occupants</label><div class="fiche-line"></div></div>
    <div class="fiche-field"><label>Animaux de compagnie</label><div class="fiche-line"></div></div>
    <div class="fiche-section-title">Documents √† joindre</div>
    <div style="font-size:0.85rem;line-height:2.2;color:var(--text-muted)">
      ‚òê Pi√®ce d'identit√© &nbsp;&nbsp; ‚òê 3 derniers bulletins de salaire &nbsp;&nbsp; ‚òê Dernier avis d'imposition &nbsp;&nbsp; ‚òê Contrat de travail &nbsp;&nbsp; ‚òê 3 derni√®res quittances &nbsp;&nbsp; ‚òê Justificatif domicile &nbsp;&nbsp; ‚òê Pi√®ce garant &nbsp;&nbsp; ‚òê Justificatifs revenus garant
    </div>
    <div class="fiche-section-title">Signature</div>
    <div style="display:flex;gap:60px;margin-top:8px">
      <div class="fiche-field" style="flex:1"><label>Date</label><div class="fiche-line"></div></div>
      <div class="fiche-field" style="flex:1"><label>Signature</label><div class="fiche-line"></div></div>
    </div>
    <div style="margin-top:20px;font-size:0.72rem;color:var(--text-muted);text-align:center;font-style:italic">Formulaire confidentiel ‚Äî usage exclusif pour l'√©tude de la candidature</div>
  `;
}

// ============================================================
// PHOTO MANAGEMENT
// ============================================================
function addPhotos(aptId, input) {
  const apt = appData.apartments.find(a => a.id === aptId);
  if (!apt) return;
  const files = Array.from(input.files);
  let loaded = 0;
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      apt.photos.push(e.target.result);
      if (++loaded === files.length) { renderPhotoGrid(apt); showToast(`${files.length} photo(s) ajout√©e(s)`); saveData(); }
    };
    reader.readAsDataURL(file);
  });
}
function renderPhotoGrid(apt) {
  const grid = document.getElementById(`photo-grid-${apt.id}`);
  if (!grid) return;
  grid.innerHTML = apt.photos.map((p, i) => `<div class="photo-thumb"><img src="${p}"><button class="photo-delete" onclick="deletePhoto(${apt.id},${i})">‚úï</button></div>`).join('')
    + `<label class="photo-add"><span class="plus">+</span><span>Ajouter</span><input type="file" accept="image/*" multiple style="display:none" onchange="addPhotos(${apt.id},this)"></label>`;
}
function deletePhoto(aptId, idx) {
  const apt = appData.apartments.find(a => a.id === aptId);
  if (!apt) return;
  apt.photos.splice(idx, 1);
  renderPhotoGrid(apt);
  saveData();
  showToast('Photo supprim√©e');
}

// ============================================================
// CANDIDATES
// ============================================================
function openAddCandidate(aptId) { appData.currentAptId = aptId; openModal('modal-add-candidate'); }
function addCandidate() {
  const name = document.getElementById('new-cand-name').value.trim();
  if (!name) { showToast('Veuillez entrer un nom', true); return; }
  const apt = appData.apartments.find(a => a.id === appData.currentAptId);
  if (!apt) return;
  apt.candidates.push({ id: Date.now(), name, status: document.getElementById('new-cand-status').value, phone: document.getElementById('new-cand-phone').value, email: document.getElementById('new-cand-email').value, job: document.getElementById('new-cand-job').value, income: parseInt(document.getElementById('new-cand-income').value)||0, notes: document.getElementById('new-cand-notes').value });
  closeModal('modal-add-candidate');
  ['name','phone','email','job','income','notes'].forEach(f => document.getElementById('new-cand-'+f).value = '');
  showToast('Candidat ajout√© !');
  saveData();
  const el = document.getElementById(`candidates-list-${appData.currentAptId}`);
  if (el) el.innerHTML = renderCandidatesHTML(apt);
}
function removeCandidate(aptId, candId) {
  const apt = appData.apartments.find(a => a.id === aptId);
  if (!apt) return;
  apt.candidates = apt.candidates.filter(c => c.id !== candId);
  const el = document.getElementById(`candidates-list-${aptId}`);
  if (el) el.innerHTML = renderCandidatesHTML(apt);
  saveData();
  showToast('Candidat supprim√©');
}

// ============================================================
// APARTMENTS
// ============================================================
function addApartment() {
  const name = document.getElementById('new-apt-name').value.trim();
  if (!name) { showToast('Nom requis', true); return; }
  const apt = { id: Date.now(), name, address: document.getElementById('new-apt-address').value, status: document.getElementById('new-apt-status').value, price: parseInt(document.getElementById('new-apt-price').value)||0, surface: parseInt(document.getElementById('new-apt-surface').value)||0, rooms: parseInt(document.getElementById('new-apt-rooms').value)||1, floor: document.getElementById('new-apt-floor').value, desc: document.getElementById('new-apt-desc').value, url: document.getElementById('new-apt-url').value, photos: [], candidates: [] };
  appData.apartments.push(apt);
  closeModal('modal-add-apt');
  ['name','address','price','surface','rooms','floor','desc','url'].forEach(f => { const el = document.getElementById('new-apt-'+f); if(el) el.value=''; });
  showToast('Appartement ajout√© !');
  saveData();
  renderDashboard();
}

function editAnnonce(aptId) {
  const apt = appData.apartments.find(a => a.id === aptId);
  if (!apt) return;
  const newDesc = prompt('Modifier l\'annonce :', apt.desc);
  if (newDesc !== null) { apt.desc = newDesc; saveData(); const el = document.getElementById(`annonce-text-${aptId}`); if (el) el.textContent = newDesc || '(Aucune description)'; showToast('Annonce mise √† jour !'); }
}

// ============================================================
// MESSAGES
// ============================================================
function addMessage() {
  const title = document.getElementById('new-msg-title').value.trim();
  const content = document.getElementById('new-msg-content').value.trim();
  if (!title || !content) { showToast('Remplissez tous les champs', true); return; }
  appData.messages.push({ id: Date.now(), title, content });
  closeModal('modal-add-msg');
  document.getElementById('new-msg-title').value = '';
  document.getElementById('new-msg-content').value = '';
  showToast('Message ajout√© !');
  saveData();
  renderMessages();
}
function deleteMessage(id) {
  if (!confirm('Supprimer ce message ?')) return;
  appData.messages = appData.messages.filter(m => m.id !== id);
  saveData();
  renderMessages();
  showToast('Message supprim√©');
}

// ============================================================
// UI HELPERS
// ============================================================
function switchTab(btn, tabId) {
  const container = btn.closest('#apt-detail-content');
  if (!container) return;
  container.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  container.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  const panel = document.getElementById(tabId);
  if (panel) panel.classList.add('active');
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }));

function copyText(text) { navigator.clipboard.writeText(text).then(() => showToast('üìã Copi√© !')); }

let toastTimer;
function showToast(msg, error = false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (error ? ' error' : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

function escapeHtml(str) { return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(str) { return (str||'').replace(/'/g,"\\'").replace(/"/g,'&quot;'); }

// ============================================================
// INIT
// ============================================================
updateGmailStatusIndicator();
renderDashboard();
</script>
</body>
</html>
